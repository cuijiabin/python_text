import pymysql
from itertools import groupby
from string import Template

g_carton_map = {
    2474582: 4,
    2474342: 4,
    2474565: 4,
    2474245: 100,
    2474252: 100,
    2936685: 5,
    2936680: 5,
    2738139: 5,
    2474219: 100,
    2738140: 4,
    2838105: 4,
    2474573: 4,
    2738141: 4,
    2506746: 4,
    2474299: 4,
    2474174: 30,
    2506748: 4,
    2738138: 5,
    2738142: 4,
    2738135: 100,
    2936678: 100,
    2738143: 4,
    2474253: 100,
    2738136: 100,
    2738132: 100,
    2738133: 100,
    2738137: 100,
    2936676: 100,
    2936681: 5,
    2936686: 5,
    2936687: 12,
    2936679: 5,
    2936684: 100,
    2936677: 100,
    2936675: 100,
    2936683: 100,
    2936682: 5,
    2474190: 100,
    2506747: 100,
    2734559: 100,
    2738134: 100,
    3039863: 16,
    2802733: 30,
    2802734: 30,
    2481497: 100,
    2961469: 10,
    4879943: 1,
    5096240: 100,
    5092977: 4,
    5092976: 4,
    5116776: 520,
    5092972: 4,
    5096235: 100,
    5096239: 100,
    5096234: 100,
    5092973: 4,
    5096238: 100,
    5092975: 4,
    5096236: 100,
    5096237: 100,
    5096241: 100,
    5092974: 4,
    5092970: 4,
    4948640: 36,
    5009094: 36,
    5009095: 48,
    5009096: 72,
    5009097: 36,
    4948636: 288,
    4948639: 288,
    4948638: 288,
    5092971: 4,
    4992192: 176,
    4992193: 110,
    4679909: 300,
    5092978: 24,
    5092968: 84,
    5116769: 144,
    5116774: 144,
    5092969: 120,
    5116770: 200,
    5116771: 80,
    5132927: 288,
    5132925: 96,
    5132924: 96,
    1817605: 24,
    2481492: 4,
    1817618: 20,
    2481491: 10,
    1768173: 30,
    1681779: 48,
    1768164: 30,
    1223100: 24,
    1817606: 60,
    1681777: 24,
    1681778: 48,
    1223097: 16,
    1817607: 120,
    2622239: 6,
    2622594: 24,
    2622595: 36,
    2576859: 36,
    2580672: 10,
    2623068: 6,
    2623072: 24,
    2604023: 40,
    2604024: 40,
    2677869: 6,
    2604022: 320,
    2604021: 400,
    2622612: 792,
    2598728: 30,
    2635664: 75,
    2802540: 18,
    2738548: 24,
    2738546: 24,
    2802732: 36,
    2738547: 24,
    2818183: 20,
    2818180: 54,
    2818181: 60,
    2871679: 100,
    2838107: 32,
    2860759: 120,
    2873154: 40,
    2873131: 24,
    2873142: 24,
    2873144: 24,
    2897151: 10,
    2873143: 24,
    2873145: 24,
    2818184: 40,
    2873150: 24,
    2873149: 24,
    2873151: 200,
    2873148: 24,
    2923256: 12,
    2874807: 20,
    2943385: 12,
    2943386: 12,
    2933856: 80,
    2921112: 36,
    3840918: 4,
    4422071: 60,
    4422070: 30,
    4548492: 100,
    4644500: 12,
    4644504: 36,
    4644501: 48,
    4644507: 36,
    4644502: 48,
    4644503: 48,
    4774852: 24,
    4775509: 36,
    4774851: 48,
    4774850: 200,
    4463683: 20,
    4775081: 24,
    4943177: 48,
    4948632: 36,
    4948631: 36,
    4948633: 240,
    4968389: 50,
    5070593: 12,
    5070594: 12,
    5132926: 288,
    5132928: 288,
    5116775: 216,
    5116773: 144,
    5255618: 20,
    5206946: 20,
    2893669: 1200,
    2893668: 1200,
    2893667: 1200,
    2893670: 1200,
    3840927: 6,
    2838106: 32,
    2580671: 24,
    3807605: 24,
    2426338: 60,
    2954039: 24,
    2481487: 24,
    2603695: 144,
    2603704: 12,
    2603706: 72,
    1817609: 12,
    1821676: 80,
    1817613: 6,
    2921113: 144,
    4464708: 70,
    2603693: 100,
    2923258: 120,
    2923260: 120,
    2923261: 80,
    2923269: 80,
    2562692: 24,
    2495703: 48,
    2598726: 12,
    3039864: 72,
    4484371: 50,
    2793988: 20,
    4310649: 12,
    2506749: 36,
    1817608: 12,
    4408044: 72,
    3840917: 48,
    2436952: 30,
    1817617: 166,
    3035630: 72,
    3035632: 72,
    3035631: 72,
    3035633: 72,
    3035634: 72,
    2927229: 60,
    1223098: 12,
    1223099: 8,
    1681773: 72,
    1681775: 4,
    2622596: 24,
    5474710: 32,
    5474711: 32,
    5474712: 32,
    5261758: 4,
    5261757: 4,
    5474706: 35,
    2481493: 35,
    2481494: 35,
    5474709: 1,
    5474708: 1,
    5474707: 1,
    5474704: 1,
    5460749: 30,
    5460767: 30,
    5460765: 30,
    5460762: 30,
    5460761: 30,
    5460759: 30,
    5460758: 30,
    5461010: 40,
    5461011: 40,
    5461009: 40,
    5486205: 12,
    5486206: 6,
    5486197: 12,
    5489628: 24,
    5489629: 24,
    5546643: 96,
    5546633: 192,
    5546639: 192,
    5585835: 25,
    5560179: 1,
    5482954: 30,
    5318580: 240,
    5377045: 20,
    4284952: 1,
    5352455: 12,
    5315749: 24,
    5514010: 36,
    2481500: 40,
    4284950: 1,
    5486234: 60,
    5425671: 3800,
    5425670: 3800,
    5474703: 40,
    5460760: 30,
    5376976: 52,
    5474705: 40,
    5474702: 40,
    5460766: 30,
    5293407: 20,
    5460764: 30,
    4284953: 1,
    5460763: 30,
    5474701: 40,
    5460768: 30,
    2481488: 24,
    4284951: 1,
    5461012: 1500,
    5461013: 1500,
    4284954: 1,
    5461014: 54,
    5486198: 4,
    5357346: 30,
    5546629: 300,
    5413267: 16,
    2734872: 40,
    2734871: 40,
    2943388: 1,
    4662858: 2,
    4662860: 12,
    4662859: 12,
    4662857: 60,
    5301775: 50,
    5486218: 4,
    5486228: 4,
    5486199: 4,
    5486201: 4,
    3039866: 36,
    4484373: 64,
    4484374: 48,
    5474714: 24,
    5474713: 24,
    1768211: 36,
    1817615: 100,
    2638019: 200,
    5410064: 10,
    5410062: 20,
    4752037: 10,
    3125019: 120,
    4463219: 50,
    5211195: 300,
    5211196: 350,
    5293710: 28,
    5292750: 324,
    5376323: 60,
    5376324: 60,
    5559301: 48,
    5486200: 4,
    2985591: 250,
    2985590: 250,
    3039865: 24,
    4210723: 216,
    4210722: 216,
    4484372: 48,
    4484375: 48,
    4284949: 100,
    5502658: 4,
    5502659: 4,
    5502660: 4,
    5502661: 4,
    5486171: 1,
    5486170: 1,
    3125018: 120,
    2978886: 60,
    1782247: 48,
    1817611: 72,
    2481496: 1,
    2481495: 1,
    2623070: 1,
    2623071: 1,
    2635674: 10,
    2936690: 84,
    2936689: 24,
    2936688: 10,
    2864135: 2,
    2954034: 24,
    2943387: 50,
    5481588: 50,
    5481589: 50,
    5481598: 68,
    5481599: 68,
    5481569: 56,
    5481570: 56,
    5481571: 56,
    5481572: 56,
    5481573: 44,
    5481574: 44,
    5481575: 44,
    5481576: 44,
    5481577: 44,
    5481578: 44,
    5481587: 36,
    5481586: 38,
    5481585: 36,
    5521182: 1,
    5521181: 1,
    5486196: 25,
    5489626: 14,
    5489627: 1,
    5489624: 1,
    5489625: 1,
    5489616: 1,
    5489617: 1,
    5565214: 1,
    5565213: 1,
    5486215: 4,
    5481596: 50,
    5481597: 40,
    5613405: 37,
    5596534: 40,
    5596532: 40,
    5521174: 80,
    5460756: 18,
    5460751: 18,
    5521173: 80,
    5460757: 18,
    5546640: 48,
    5546636: 48,
    5546632: 48,
    5460753: 18,
    5460752: 18,
    5460750: 18,
    5627686: 48,
    5627688: 48,
    5627687: 48,
    5627685: 48,
    5627689: 48,
    5627690: 48,
    5502663: 4,
    5502664: 4,
    5502655: 16,
    5489615: 1,
    5585123: 36,
    5486227: 4,
    5502662: 4,
    5502649: 4,
    5486204: 12,
    5486216: 4,
    5486217: 4,
    5502647: 4,
    5481593: 40,
    5546635: 48,
    5546628: 48,
    5559546: 48,
    5546638: 50,
    5546631: 24,
    5546630: 96,
    5546644: 30,
    5546637: 48,
    5559302: 300,
    5596531: 40,
    5606234: 12,
    5596535: 40,
    5502654: 16,
    5502653: 16,
    5502648: 4,
    5502650: 16,
    5521180: 1,
    5521179: 1,
    5596533: 40,
    5546641: 24,
    5502665: 4,
    5546642: 24,
    5673992: 1,
    5673993: 1,
    5675554: 160,
    5683191: 60,
    1681772: 12,
    1681776: 12,
    5486232: 4,
    5733352: 40,
    5502666: 4,
    5502656: 16,
    5502652: 16,
    5413266: 84,
    5766950: 144,
    5638563: 100,
    5628290: 48,
    5567847: 10,
    5641522: 48,
    5638561: 36,
    5546634: 24,
    5631915: 70,
    5643207: 40,
    5591050: 40,
    5591049: 40,
    5685366: 1,
    5734484: 240,
    5486202: 12,
    5698172: 10,
    5532501: 30,
    5532500: 54,
    5532499: 30,
    5532498: 54,
    5738412: 138,
    5670317: 100,
    5628291: 24,
    5647764: 60,
    5567850: 10,
    5635885: 20,
    5567849: 10,
    5635882: 20,
    5641519: 72,
    5567848: 10,
    5635883: 20,
    5591048: 40,
    5661725: 120,
    5647763: 12,
    5647762: 12,
    5641520: 36,
    5643219: 100,
    5643208: 72,
    5489630: 24,
    5667334: 100,
    5565956: 48,
    5734483: 300,
    5502657: 16,
    5502651: 16,
    5596530: 24,
    5822718: 28,
    5754432: 36,
    5822709: 28,
    5822706: 28,
    5822710: 28,
    5822714: 28,
    5822712: 28,
    5787853: 36,
    5822715: 28,
    5670349: 30,
    5742079: 28,
    5822705: 28,
    5822719: 28,
    5637669: 40,
    5637668: 40,
    5822720: 28,
    5822711: 28,
    5822716: 28,
    5822713: 28,
    5790782: 48,
    5636821: 24,
    5822707: 28,
    5822708: 28,
    5822721: 28,
    5822717: 28,
    5822722: 28,
    5790776: 48,
    5686246: 125,
    5791727: 672,
    5791646: 672,
    5791645: 672,
    5565211: 1500,
    5822723: 28,
    5822725: 28,
    5686247: 125,
    5822724: 28,
    5565212: 1500,
    5641523: 48,
    5641521: 36,
    5782167: 12,
    5486212: 24,
    5810521: 1,
    1070377: 6,
    1000017: 6,
    1000002: 6,
    1000039: 6,
    1000040: 6,
    1000670: 6,
    1000021: 6,
    1000020: 6,
    1000016: 6,
    1000019: 6,
    1000018: 6,
    1000004: 6,
    1057857: 6,
    1000257: 6,
    1000258: 6,
    5738216: 6,
    1070290: 6,
    1004404: 6,
    1004408: 6,
    1004406: 6,
    1004405: 6,
    1015547: 6,
    1015546: 6,
    1015548: 6,
    1004402: 6,
    1679588: 6,
    1060066: 6,
    1060067: 6,
    1060069: 6,
    1060125: 6,
    1003096: 6,
    1003097: 6,
    1003090: 6,
    1003094: 6,
    1003095: 6,
    1003084: 6,
    2991933: 6,
    2991934: 6,
    1084269: 6,
    3004027: 6,
    1099403: 6,
    1099404: 6,
    1028028: 6,
    5482950: 6,
    5482951: 6,
    5482953: 6,
    5482952: 6,
    4205971: 6,
    1002963: 6
}

special_spu_map = {
    5876463: 1,
    5876464: 1,
    5876465: 1,
    5876466: 1,
    5876467: 1,
    5876469: 1
}


def get_mia_cursor(db_name="mia_mirror"):
    conn = pymysql.connect(host="10.5.96.80",
                           port=3306,
                           user="pop_cuijiabin",
                           passwd="8dtx5EOUZASc#",
                           db=db_name,
                           charset="utf8")
    return conn.cursor()


def get_superior_order_list(superior_order_code):
    cur = get_mia_cursor("mia_mirror")
    sql_tmp = Template(
        "SELECT o.order_code,o.warehouse_id,oi.item_id, oi.spu_id "
        "from order_item oi LEFT JOIN orders o on oi.order_id = o.id "
        "WHERE oi.order_id in (SELECT id from orders where superior_order_code = '$superior_order_code') and oi.item_id not in (5877369, 5882959) "
        "ORDER BY oi.order_id ASC")
    sql = sql_tmp.substitute(superior_order_code=superior_order_code)
    cur.execute(sql)

    columns = [col[0] for col in cur.description]
    rows = [dict(zip(columns, row)) for row in cur.fetchall()]
    cur.close()
    return rows


def judge_carton_order(superior_order_code):
    detail_list = get_superior_order_list(superior_order_code)

    target_order_code_list = []
    carton_mark = False
    for k, g in groupby(detail_list, lambda x: x["order_code"]):
        sub_list = list(g)
        spu_set = list(set(map(lambda x: x["spu_id"], sub_list)))
        if len(spu_set) == 1 and special_spu_map.get(spu_set[0]) is not None:
            carton_mark = True
            continue

        item_set = list(set(map(lambda x: x["item_id"], sub_list)))
        if len(spu_set) == 1 and len(item_set) == 1 and g_carton_map.get(item_set[0]) is not None:
            carton_size = g_carton_map.get(item_set[0])
            if len(sub_list) % carton_size == 0:
                carton_mark = True
                continue

        target_order_code_list.append(k)

    if carton_mark and len(target_order_code_list) > 0:
        for tg in target_order_code_list:
            print("子订单"+tg)
    elif not carton_mark:
        print("非箱规订单" + superior_order_code)
    else:
        print("完全非箱规订单" + superior_order_code)


if __name__ == '__main__':
    s_code_list = ['202101052404850423', '202101052405048476', '202101052404827253', '202101052404804983']
    for s_code in s_code_list:
        judge_carton_order(s_code)
